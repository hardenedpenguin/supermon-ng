{"version":3,"file":"Voter-BDeqVwg7.js","sources":["../../src/components/Voter.vue"],"sourcesContent":["<template>\n  <div v-if=\"show\" class=\"voter-modal-overlay\" @click=\"closeModal\">\n    <div class=\"voter-modal\" @click.stop>\n      <div class=\"voter-modal-header\">\n        <h2>Voter Status</h2>\n        <button class=\"close-button\" @click=\"closeModal\">&times;</button>\n      </div>\n      \n      <div class=\"voter-modal-content\">\n        <!-- Node Input -->\n        <div class=\"voter-input-section\">\n          <label for=\"voter-nodes\">Node(s):</label>\n          <input \n            id=\"voter-nodes\"\n            v-model=\"nodeInput\" \n            type=\"text\" \n            placeholder=\"Enter node number(s) e.g., 1234 or 1234,5678\"\n            @keyup.enter=\"startVoter\"\n          />\n          <button @click=\"startVoter\" :disabled=\"!nodeInput.trim()\">Start Voter</button>\n        </div>\n\n        <!-- Voter Containers -->\n        <div v-if=\"nodes.length > 0\" class=\"voter-containers\">\n          <div v-for=\"node in nodes\" :key=\"node\" class=\"voter-container\">\n            <div :id=\"`link_list_${node}`\" class=\"voter-content\">\n              Connecting to Node {{ node }}...\n            </div>\n            <div class=\"voter-spinner\">\n              <span :id=\"`spinner_${node}`\" class=\"spinner-text\">{{ getSpinner(node) }}</span>\n            </div>\n          </div>\n        </div>\n\n        <!-- Voter Information -->\n        <div class=\"voter-info-container\">\n          <div class=\"voter-description\">\n            The numbers indicate the relative signal strength. The value ranges from 0 to 255, a range of approximately 30db.\n            A value of zero means that no signal is being received. The color of the bars indicate the type of RTCM client.\n          </div>\n          <div class=\"voter-legend\">\n            <div class=\"legend-item legend-voting\">A blue bar indicates a voting station.</div>\n            <div class=\"legend-item legend-voted\">Green indicates the station is voted.</div>\n            <div class=\"legend-item legend-mix\">Cyan is a non-voting mix station.</div>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script setup>\nimport { ref, onUnmounted, watch } from 'vue'\nimport { api } from '@/utils/api'\nimport { sanitizeHtml } from '@/utils/sanitize'\n\nconst props = defineProps({\n  show: {\n    type: Boolean,\n    default: false\n  }\n})\n\nconst emit = defineEmits(['close'])\n\nconst nodeInput = ref('')\nconst nodes = ref([])\nconst eventSources = ref({})\nconst spinners = ref({})\nconst spinnerChars = ['*', '|', '/', '-', '\\\\']\nlet spinnerInterval = null\nconst pollingTimeouts = ref(new Map())\n\nconst closeModal = () => {\n  stopVoter()\n  emit('close')\n}\n\nconst startVoter = () => {\n  if (!nodeInput.value.trim()) return\n  \n  // Parse nodes\n  const nodeList = nodeInput.value.split(',').map(n => n.trim()).filter(n => n)\n  if (nodeList.length === 0) return\n  \n  nodes.value = nodeList\n  startSpinner()\n  initializeEventSources()\n}\n\nconst stopVoter = () => {\n  // Close all event sources\n  Object.values(eventSources.value).forEach(source => {\n    if (source) {\n      source.close()\n    }\n  })\n  eventSources.value = {}\n  \n  // Clear spinner interval\n  if (spinnerInterval) {\n    clearInterval(spinnerInterval)\n    spinnerInterval = null\n  }\n  \n  // Clear all polling timeouts to prevent memory leaks\n  pollingTimeouts.value.forEach((timeout, node) => {\n    clearTimeout(timeout)\n  })\n  pollingTimeouts.value.clear()\n  \n  // Reset state\n  nodes.value = []\n  spinners.value = {}\n}\n\nconst startSpinner = () => {\n  let spinIndex = 0\n  spinnerInterval = setInterval(() => {\n    nodes.value.forEach(node => {\n      spinners.value[node] = spinnerChars[spinIndex]\n    })\n    spinIndex = (spinIndex + 1) % spinnerChars.length\n  }, 200)\n}\n\nconst getSpinner = (node) => {\n  return spinners.value[node] || '*'\n}\n\nconst initializeEventSources = () => {\n  nodes.value.forEach(node => {\n    if (node && node.trim() !== '') {\n      // Use polling instead of EventSource for compatibility\n      pollVoterStatus(node)\n    }\n  })\n}\n\nconst pollVoterStatus = async (node) => {\n  // Check if node is still being monitored (prevents polling after stopVoter is called)\n  if (!nodes.value.includes(node)) {\n    return\n  }\n  \n  try {\n    const response = await api.get(`/nodes/voter/status?node=${encodeURIComponent(node)}`)\n    \n    if (response.data.html) {\n      const element = document.getElementById(`link_list_${node}`)\n      if (element) {\n        element.innerHTML = sanitizeHtml(response.data.html)\n      }\n    }\n    \n    if (response.data.spinner) {\n      spinners.value[node] = response.data.spinner\n    }\n    \n    // Continue polling only if node is still being monitored\n    if (nodes.value.includes(node)) {\n      const timeoutId = setTimeout(() => pollVoterStatus(node), 1000)\n      pollingTimeouts.value.set(node, timeoutId)\n    }\n    \n  } catch (error) {\n    console.error(`Error polling voter status for node ${node}:`, error)\n    const element = document.getElementById(`link_list_${node}`)\n    if (element) {\n      element.innerHTML = sanitizeHtml(`<div class='error-message'>Error receiving updates for node ${node}. The connection was lost.</div>`)\n    }\n    spinners.value[node] = 'X'\n    \n    // Clear timeout for this node on error\n    const timeoutId = pollingTimeouts.value.get(node)\n    if (timeoutId) {\n      clearTimeout(timeoutId)\n      pollingTimeouts.value.delete(node)\n    }\n  }\n}\n\n// Cleanup on unmount\nonUnmounted(() => {\n  stopVoter()\n})\n\n// Watch for modal close\nwatch(() => props.show, (newVal) => {\n  if (!newVal) {\n    stopVoter()\n  }\n})\n</script>\n\n<style scoped>\n.voter-modal-overlay {\n  position: fixed;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  background-color: rgba(0, 0, 0, 0.8);\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  z-index: 1000;\n}\n\n.voter-modal {\n  background-color: var(--modal-bg);\n  border-radius: 8px;\n  width: 90%;\n  max-width: 800px;\n  max-height: 90vh;\n  overflow-y: auto;\n  color: var(--text-color);\n}\n\n.voter-modal-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  padding: 20px;\n  border-bottom: 1px solid var(--border-color);\n}\n\n.voter-modal-header h2 {\n  margin: 0;\n  color: var(--text-color);\n}\n\n.close-button {\n  background: none;\n  border: none;\n  color: var(--text-color);\n  font-size: 24px;\n  cursor: pointer;\n  padding: 0;\n  width: 30px;\n  height: 30px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n}\n\n.close-button:hover {\n  background-color: var(--border-color);\n  border-radius: 4px;\n}\n\n.voter-modal-content {\n  padding: 20px;\n}\n\n.voter-input-section {\n  margin-bottom: 20px;\n  display: flex;\n  gap: 10px;\n  align-items: center;\n  flex-wrap: wrap;\n}\n\n.voter-input-section label {\n  font-weight: bold;\n  color: var(--text-color);\n}\n\n.voter-input-section input {\n  flex: 1;\n  min-width: 200px;\n  padding: 8px 12px;\n  border: 1px solid var(--border-color);\n  border-radius: 4px;\n  background-color: var(--container-bg);\n  color: var(--text-color);\n}\n\n.voter-input-section button {\n  padding: 8px 16px;\n  background-color: var(--button-bg);\n  color: var(--text-color);\n  border: none;\n  border-radius: 4px;\n  cursor: pointer;\n}\n\n.voter-input-section button:hover {\n  background-color: var(--button-hover);\n}\n\n.voter-input-section button:disabled {\n  background-color: var(--border-color);\n  cursor: not-allowed;\n}\n\n.voter-containers {\n  margin-bottom: 20px;\n}\n\n.voter-container {\n  margin-bottom: 20px;\n  padding: 15px;\n  border: 1px solid var(--border-color);\n  border-radius: 4px;\n  background-color: var(--container-bg);\n}\n\n.voter-content {\n  margin-bottom: 10px;\n}\n\n.voter-spinner {\n  text-align: center;\n}\n\n.spinner-text {\n  font-family: monospace;\n  font-size: 18px;\n  color: var(--link-color);\n}\n\n.voter-info-container {\n  background-color: var(--container-bg);\n  padding: 15px;\n  border-radius: 4px;\n  border: 1px solid var(--border-color);\n}\n\n.voter-description {\n  margin-bottom: 15px;\n  color: var(--text-color);\n  line-height: 1.5;\n}\n\n.voter-legend {\n  display: flex;\n  flex-direction: column;\n  gap: 8px;\n}\n\n.legend-item {\n  padding: 5px 10px;\n  border-radius: 4px;\n  font-size: 14px;\n}\n\n.legend-voting {\n  background-color: var(--link-color);\n  color: var(--background-color);\n}\n\n.legend-voted {\n  background-color: var(--success-color);\n  color: var(--background-color);\n}\n\n.legend-mix {\n  background-color: var(--warning-color);\n  color: var(--background-color);\n}\n\n.error-message {\n  color: var(--error-color);\n  padding: 10px;\n  background-color: var(--container-bg);\n  border: 1px solid var(--error-color);\n  border-radius: 4px;\n}\n\n/* Voter table styles */\n:deep(.rtcm) {\n  width: 100%;\n  border-collapse: collapse;\n  margin-bottom: 10px;\n}\n\n:deep(.rtcm th) {\n  background-color: var(--table-header-bg);\n  color: var(--text-color);\n  padding: 8px;\n  text-align: left;\n  border: 1px solid var(--border-color);\n}\n\n:deep(.rtcm td) {\n  padding: 8px;\n  border: 1px solid var(--border-color);\n  background-color: var(--container-bg);\n}\n\n:deep(.rtcm a) {\n  color: var(--link-color);\n  text-decoration: none;\n}\n\n:deep(.rtcm a:hover) {\n  text-decoration: underline;\n}\n\n:deep(.barbox_a) {\n  width: 300px;\n  height: 20px;\n  border: 1px solid #555;\n  background-color: #1a1a1a;\n  position: relative;\n}\n\n:deep(.bar) {\n  height: 100%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-size: 12px;\n  font-weight: bold;\n  min-width: 20px;\n}\n\n:deep(.voter-no-clients) {\n  color: #999;\n  font-style: italic;\n}\n\n:deep(.voter-empty-bar) {\n  background-color: #1a1a1a;\n  height: 20px;\n  border: 1px solid #555;\n}\n\n:deep(.text) {\n  display: flex;\n  align-items: center;\n}\n</style>\n"],"names":["props","__props","emit","__emit","nodeInput","ref","nodes","eventSources","spinners","spinnerChars","spinnerInterval","pollingTimeouts","closeModal","stopVoter","startVoter","nodeList","n","startSpinner","initializeEventSources","source","timeout","node","spinIndex","getSpinner","pollVoterStatus","response","api","element","sanitizeHtml","timeoutId","error","onUnmounted","watch","newVal","_createElementBlock","_createElementVNode","_cache","_hoisted_1","_hoisted_2","$event","_hoisted_3","_openBlock","_hoisted_4","_Fragment","_renderList","_toDisplayString","_hoisted_5","_hoisted_6","_hoisted_7"],"mappings":"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"}